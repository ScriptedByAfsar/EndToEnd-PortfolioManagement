<nav class="menu-bar">
  <button (click)="toggleTheme()" class="theme-toggle" [class.dark-mode]="isDarkMode">
    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1-8.313-12.454z"/>
    </svg>
  </button>
  <div class="menu-items">
    <div class="centered-items">
      <button (click)="openCard('profile')" class="menu-item">Profile</button>
      <button (click)="navigateToDashboard()" class="menu-item">Dashboard</button>
      <button (click)="openCard('totals')" class="menu-item">Totals</button>
      <button (click)="openCard('editMaster')" class="menu-item">Edit Master</button>
      <button (click)="openCard('history')" class="menu-item">Transaction History</button>
    </div>
    <button (click)="logout()" class="menu-item logout">Logout</button>
  </div>
</nav>

<!-- Overlay card -->
<div class="card-overlay" *ngIf="showCard" (click)="closeCard()">
  <div class="card" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeCard()">×</button>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <p>Loading...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="error-state">
      <p>{{ error }}</p>
      <button (click)="loadSummary()" class="retry-btn">Retry</button>
    </div>

    <!-- Profile Card -->
    <div *ngIf="cardType === 'profile' && !isLoading && !error" class="card-content profile-card">
      <h2>Profile</h2>
      <div class="profile-container">
        <div class="profile-photo-section">
          <div class="photo-container">
            <img [src]="isEditingProfile ? tempProfile.photoUrl : profile.photoUrl" 
                 alt="Profile photo" 
                 class="profile-photo">
            <div *ngIf="isEditingProfile" class="photo-overlay">
              <input type="file" 
                     accept="image/*" 
                     (change)="onPhotoSelected($event)" 
                     #fileInput 
                     class="file-input">
              <button class="change-photo-btn" (click)="fileInput.click()">
                Change Photo
              </button>
            </div>
          </div>
        </div>

        <div class="profile-details">
          <div class="profile-fields" [class.editing]="isEditingProfile">
            <div class="field">
              <label>Username</label>
              <span *ngIf="!isEditingProfile">{{ profile.username }}</span>
              <input *ngIf="isEditingProfile" 
                     type="text" 
                     [(ngModel)]="tempProfile.username" 
                     placeholder="Username">
            </div>

            <div class="field">
              <label>Email</label>
              <span *ngIf="!isEditingProfile">{{ profile.email || 'Not set' }}</span>
              <input *ngIf="isEditingProfile" 
                     type="email" 
                     [(ngModel)]="tempProfile.email" 
                     placeholder="Enter your email">
            </div>

            <div class="field">
              <label>Mobile</label>
              <span *ngIf="!isEditingProfile">{{ profile.mobile || 'Not set' }}</span>
              <input *ngIf="isEditingProfile" 
                     type="tel" 
                     [(ngModel)]="tempProfile.mobile" 
                     placeholder="Enter your mobile number">
            </div>
          </div>

          <div class="profile-actions">
            <ng-container *ngIf="!isEditingProfile">
              <button class="edit-btn" (click)="startEditingProfile()">
                Edit Profile
              </button>
            </ng-container>
            <ng-container *ngIf="isEditingProfile">
              <button class="save-btn" (click)="saveProfile()">
                Save Changes
              </button>
              <button class="cancel-btn" (click)="cancelEditProfile()">
                Cancel
              </button>
            </ng-container>
          </div>

          <div class="danger-zone">
            <button class="clear-data-btn" (click)="showClearDataConfirmation()">
              Clear All Data
            </button>
          </div>
        </div>
      </div>

      <!-- Clear Data Confirmation Modal -->
      <div class="modal-overlay" *ngIf="showClearDataModal" (click)="cancelClearData()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <h3>⚠️ Warning: Clear All Data</h3>
          <p>Are you sure you want to clear all data? This action cannot be undone and will:</p>
          <ul>
            <li>Delete all transaction history</li>
            <li>Remove all goals and investments</li>
            <li>Clear all master data</li>
            <li>Log you out of the application</li>
          </ul>
          <p class="warning-text">This action is permanent and cannot be reversed!</p>
          <div class="modal-actions">
            <button class="modal-cancel" (click)="cancelClearData()">Cancel</button>
            <button class="modal-confirm" (click)="confirmClearData()">Yes, Clear Everything</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Totals Card -->
    <div *ngIf="cardType === 'totals' && !isLoading && !error" class="card-content">
      <h2>Totals</h2>
      
      <div class="totals-options">
        <button (click)="subType = 'invested'" [class.active]="subType === 'invested'">Invested Details</button>
        <button (click)="subType = 'goals'" [class.active]="subType === 'goals'">Goals Details</button>
      </div>

      <!-- Invested Details -->
      <div *ngIf="subType === 'invested'">
        <table>
          <thead>
            <tr>
              <th>Plan Name</th>
              <th>Amount</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detail of investedSummary">
              <td>{{ detail.name }}</td>
              <td>{{ detail.amount | currency }}</td>
              <td>{{ detail.percentage }}%</td>
              <td>{{ detail.timestamp | date:'medium' }}</td>
            </tr>
          </tbody>
        </table>
        <div class="total-amount">
          Total Invested Amount Till Now: {{ totalInvestedAmount | currency }}
        </div>
      </div>

      <!-- Goals Details -->
      <div *ngIf="subType === 'goals'">
        <table>
          <thead>
            <tr>
              <th>Goal Name</th>
              <th>Amount</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detail of goalsSummary">
              <td>{{ detail.name }}</td>
              <td>{{ detail.amount | currency }}</td>
              <td>{{ detail.percentage }}%</td>
              <td>{{ detail.timestamp | date:'medium' }}</td>
            </tr>
          </tbody>
        </table>
        <div class="total-amount">
          Total Goals Amount: {{ totalGoalsAmount | currency }}
        </div>
      </div>
    </div>

    <!-- Transaction History Card -->
    <div *ngIf="cardType === 'history' && !isLoading && !error" class="card-content">
      <h2>Transaction History</h2>
      
      <div class="history-options">
        <button (click)="switchHistoryType('invested')" [class.active]="subType === 'invested'">Invested History</button>
        <button (click)="switchHistoryType('goals')" [class.active]="subType === 'goals'">Goals History</button>
      </div>

      <div class="table-container" [class.slide-left]="slideDirection === 'next'" [class.slide-right]="slideDirection === 'prev'">
        <table>
          <thead>
            <tr>
              <th>{{ subType === 'invested' ? 'Plan Name' : 'Goal Name' }}</th>
              <th>Amount</th>
              <th>Percentage</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detail of (subType === 'invested' ? investedDetails : goalsDetails)"
                [@fadeInOut]>
              <td>{{ subType === 'invested' ? detail.planName : detail.goalName }}</td>
              <td>{{ detail.amount | currency }}</td>
              <td>{{ detail.percentage }}%</td>
              <td>{{ detail.timestamp | date:'medium' }}</td>
            </tr>
            <tr *ngIf="(subType === 'invested' ? investedDetails : goalsDetails).length === 0">
              <td colspan="4" class="no-data">No transactions found</td>
            </tr>
          </tbody>
        </table>

        <div class="pagination-controls">
          <button class="pagination-btn" 
                  [disabled]="currentPage === 1"
                  (click)="navigatePage('prev')"
                  [@buttonPulse]="prevButtonState">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="page-info">Page {{currentPage}} of {{totalPages}}</span>
          <button class="pagination-btn" 
                  [disabled]="currentPage === totalPages"
                  (click)="navigatePage('next')"
                  [@buttonPulse]="nextButtonState">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Master Card -->
    <div *ngIf="cardType === 'editMaster'" class="card-content">
      <h2>Edit Master Data</h2>
      
      <!-- Error message for duplicates -->
      <div *ngIf="error" class="error-message">
        {{ error }}
      </div>
      
      <div class="master-sections-container">
        <div class="master-section">
          <h3>Investment Assets</h3>
          <!-- Add new asset -->
          <div class="add-form">
            <input type="text" [(ngModel)]="newAssetName" placeholder="New asset name">
            <button (click)="addAsset()">Add Asset</button>
          </div>
          
          <!-- Assets list -->
          <div class="master-list">
            <div *ngFor="let asset of masterAssets" class="master-item">
              <div *ngIf="!editMode[asset.id]" class="item-view">
                <span>{{ asset.name }}</span>
                <div class="item-actions">
                  <button (click)="editMode[asset.id] = true">Edit</button>
                  <button (click)="deleteAsset(asset.id)" class="delete">Delete</button>
                </div>
              </div>
              <div *ngIf="editMode[asset.id]" class="item-edit">
                <input type="text" [(ngModel)]="asset.name">
                <div class="item-actions">
                  <button (click)="updateAsset(asset)">Save</button>
                  <button (click)="editMode[asset.id] = false">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="master-section">
          <h3>Goals</h3>
          <!-- Add new goal -->
          <div class="add-form">
            <input type="text" [(ngModel)]="newGoalName" placeholder="New goal name">
            <button (click)="addGoal()">Add Goal</button>
          </div>
          
          <!-- Goals list -->
          <div class="master-list">
            <div *ngFor="let goal of masterGoals" class="master-item">
              <div *ngIf="!editMode[goal.id]" class="item-view">
                <span>{{ goal.name }}</span>
                <div class="item-actions">
                  <button (click)="editMode[goal.id] = true">Edit</button>
                  <button (click)="deleteGoal(goal.id)" class="delete">Delete</button>
                </div>
              </div>
              <div *ngIf="editMode[goal.id]" class="item-edit">
                <input type="text" [(ngModel)]="goal.name">
                <div class="item-actions">
                  <button (click)="updateGoal(goal)">Save</button>
                  <button (click)="editMode[goal.id] = false">Cancel</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
